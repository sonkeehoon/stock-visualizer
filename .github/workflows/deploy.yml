name: Deploy repo to EC2

on:
  push:
    branches: [ "master" ]
    paths:
      - "Makefile"
      - "Dockerfile"
      - "app.py"
      - "crawler.py"
      - "requirements.txt"
      - "visualizer.py"

env:
  DOCKER_IMAGE: stock-visualizer   # ğŸ§© Docker ì´ë¯¸ì§€ ì´ë¦„
  CONTAINER_NAME: stock-visualizer # ğŸ§© ì»¨í…Œì´ë„ˆ ì´ë¦„
  HOST_PORT: 80                    # ğŸ§© EC2 ì™¸ë¶€ì—ì„œ ì ‘ì†í•  í¬íŠ¸
  CONTAINER_PORT: 80               # ğŸ§© ì»¨í…Œì´ë„ˆ í¬íŠ¸
  EC2_APP_PATH: ~/stock-visualizer # ğŸ§© EC2ì˜ ì•± ë””ë ‰í„°ë¦¬ ê²½ë¡œ

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Deploy to EC2 instance
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            echo "ğŸš€ Deploying ${{ env.DOCKER_IMAGE }} to EC2..."

            cd ${{ env.EC2_APP_PATH }}
            git fetch origin master
            git reset --hard origin/master

            echo "ğŸ§¹ Cleaning old containers/images..."
            docker stop ${{ env.CONTAINER_NAME }} || true
            docker rm ${{ env.CONTAINER_NAME }} || true
            docker system prune -af

            echo "ğŸ—ï¸ Building new Docker image..."
            docker build -t ${{ env.DOCKER_IMAGE }} .

            echo "ğŸš€ Running new container..."
            docker run -d \
              --name ${{ env.CONTAINER_NAME }} \
              -p ${{ env.HOST_PORT }}:${{ env.CONTAINER_PORT }} \
              --restart always \
              ${{ env.DOCKER_IMAGE }}

            echo "âœ… Deployment complete!"
            echo "ğŸ” Checking server health..."
            sleep 5
            curl -f http://localhost:${{ env.HOST_PORT }} || (echo "âŒ Health check failed!" && exit 1)
            echo "âœ… Server is healthy!"
